{% extends "base.html" %}
{% block content %}
<div class="container-fluid pt-4 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div><h5 class="fw-bold text-wine mb-0">{{ user_name }}</h5><span class="badge bg-wine">{{ role }}</span></div>
        <div><a href="/admin" class="btn btn-sm btn-outline-dark me-1">Jadwal</a> <a href="/logout" class="btn btn-sm btn-outline-danger">Logout</a></div>
    </div>

    <div class="card card-glass mb-4 p-3 border-wine">
        <h6 class="fw-bold text-wine mb-2">Absensi Anda</h6>
        <div class="row">
            <div class="col-md-5 mb-2">
                <div class="overflow-hidden position-relative rounded" style="height: 200px; background:#000;">
                    <video id="video" autoplay playsinline muted style="width:100%; height:100%; object-fit:cover; transform:scaleX(-1);"></video>
                    <canvas id="canvas" style="display:none;"></canvas>
                </div>
            </div>
            <div class="col-md-7">
                <div id="status-display" class="fw-bold text-muted mb-2">Loading...</div>
                <div id="shift-buttons" class="row g-1 mb-2">
                    <div class="col-4"><button class="btn btn-sm btn-outline-secondary w-100 shift-btn" data-shift="Pagi">Pagi</button></div>
                    <div class="col-4"><button class="btn btn-sm btn-outline-secondary w-100 shift-btn" data-shift="Siang">Siang</button></div>
                    <div class="col-4"><button class="btn btn-sm btn-outline-secondary w-100 shift-btn" data-shift="Sore">Sore</button></div>
                </div>
                <button id="btn-in" class="btn btn-wine w-100 btn-sm" disabled>CHECK IN</button>
                <button id="btn-out" class="btn btn-danger w-100 btn-sm" style="display:none;">CHECK OUT</button>
            </div>
        </div>
    </div>

    {% if pending_users %}
    <div class="card card-glass mb-4 border-warning"><div class="card-header bg-transparent fw-bold text-wine">Approval User</div>
        <table class="table table-borderless small mb-0">{% for u in pending_users %}<tr><td>{{ u.full_name }}<br><span class="text-muted">{{ u.role }} - {{ u.branch }}</span></td><td class="text-end"><form action="/approve_user/{{ u.id }}" method="POST"><button class="btn btn-sm btn-success">ACC</button></form></td></tr>{% endfor %}</table>
    </div>
    {% endif %}

    <div class="card card-glass">
        <div class="card-header bg-transparent d-flex justify-content-between"><span class="fw-bold text-wine">Monitoring</span> <a href="/export" class="text-success small fw-bold">Excel</a></div>
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 small"><thead class="table-light"><tr><th>Nama</th><th>Shift</th><th>Waktu</th><th>Foto</th><th>Act</th></tr></thead>
            <tbody>{% for row in monitoring_data %}<tr>
                <td><strong>{{ row.name }}</strong><br><span class="badge bg-light text-dark border">{{ row.branch }}</span></td>
                <td>{{ row.shift }}</td>
                <td>{{ row.in }}<br>{{ row.out }}</td>
                <td>
                    {% if row.photo_in %}<button class="btn btn-sm btn-outline-wine py-0" onclick="showPhoto('{{ row.photo_in }}','IN')">IN</button>{% endif %}
                    {% if row.photo_out %}<button class="btn btn-sm btn-outline-danger py-0" onclick="showPhoto('{{ row.photo_out }}','OUT')">OUT</button>{% endif %}
                </td>
                <td>{% if row.potential_overtime and not row.is_overtime %}<form action="/approve_overtime/{{ row.id }}" method="POST"><button class="btn btn-sm btn-outline-primary py-0">ACC Lembur</button></form>{% endif %}</td>
            </tr>{% else %}<tr><td colspan="5" class="text-center text-muted">Kosong</td></tr>{% endfor %}</tbody></table>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
    let currentShift=null; let loc={lat:null,lng:null}; const video=document.getElementById('video');
    navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}}).then(s=>video.srcObject=s);
    navigator.geolocation.getCurrentPosition(p=>{loc.lat=p.coords.latitude;loc.lng=p.coords.longitude;});
    document.querySelectorAll('.shift-btn').forEach(b=>{b.onclick=()=>{
        document.querySelectorAll('.shift-btn').forEach(x=>x.classList.remove('btn-wine','text-white'));
        b.classList.add('btn-wine','text-white'); currentShift=b.getAttribute('data-shift');
        document.getElementById('btn-in').disabled=false;
    }});
    async function send(type){
        const cvs=document.getElementById('canvas'); cvs.width=video.videoWidth; cvs.height=video.videoHeight;
        cvs.getContext('2d').drawImage(video,0,0);
        const res=await fetch('/api/'+type,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({shift:currentShift,photo:cvs.toDataURL('image/jpeg'),lat:loc.lat,lng:loc.lng})});
        const d=await res.json(); if(d.success){Swal.fire('Sukses','','success').then(()=>location.reload());}else{Swal.fire('Gagal',d.message,'error');}
    }
    document.getElementById('btn-in').onclick=()=>send('check_in'); document.getElementById('btn-out').onclick=()=>send('check_out');
    fetch('/api/status').then(r=>r.json()).then(d=>{
        const disp=document.getElementById('status-display');
        if(d.status==='CheckedIn'){disp.innerHTML=`<span class="text-success">IN: ${d.check_in_time}</span>`; document.getElementById('btn-in').style.display='none'; document.getElementById('btn-out').style.display='block'; document.getElementById('shift-buttons').style.display='none';}
        else if(d.status==='CheckedOut'){disp.innerHTML=`<span class="text-danger">OUT: ${d.check_out_time}</span>`; document.getElementById('btn-in').style.display='none'; document.getElementById('shift-buttons').style.display='none';}
        else{disp.innerText="Pilih Shift:";}
    });
</script>
{% endblock %}