{% extends "base.html" %}
{% block content %}
<div id="home-section" class="container pt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="fw-bold text-wine">Halo, {{ user_name }}</h5>
        <a href="/logout" class="text-danger"><i class="fas fa-sign-out-alt"></i></a>
    </div>
    <div class="card card-glass p-3 mb-3 text-center"><div id="status-display" class="fw-bold text-muted">Loading...</div></div>
    <div class="card card-glass p-1 mb-3 overflow-hidden position-relative" style="height:300px;">
        <video id="video" autoplay playsinline muted style="width:100%;height:100%;object-fit:cover;transform:scaleX(-1);border-radius:15px;"></video>
        <canvas id="canvas" style="display:none;"></canvas>
    </div>
    <div id="shift-buttons" class="row g-2 mb-2">
        <div class="col-4"><button class="btn btn-outline-secondary w-100 py-3 shift-btn" data-shift="Pagi">Pagi</button></div>
        <div class="col-4"><button class="btn btn-outline-secondary w-100 py-3 shift-btn" data-shift="Siang">Siang</button></div>
        <div class="col-4"><button class="btn btn-outline-secondary w-100 py-3 shift-btn" data-shift="Sore">Sore</button></div>
    </div>
    <button id="btn-in" class="btn btn-wine w-100 py-3 mb-2 fw-bold" disabled>CHECK IN</button>
    <button id="btn-out" class="btn btn-danger w-100 py-3 mb-2 fw-bold" style="display:none;">CHECK OUT</button>
</div>

<div id="history-section" class="container pt-4" style="display:none;">
    <h5 class="fw-bold text-wine mb-3">Riwayat</h5>
    <div id="history-list" class="list-group list-group-flush rounded-3 card-glass"></div>
</div>

<div class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('home',this)"><i class="fas fa-home"></i>Home</div>
    <div class="nav-item" onclick="switchTab('history',this)"><i class="fas fa-history"></i>History</div>
</div>

<script>
    let currentShift=null; let loc={lat:null,lng:null}; const video=document.getElementById('video');
    navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}}).then(s=>video.srcObject=s);
    navigator.geolocation.getCurrentPosition(p=>{loc.lat=p.coords.latitude;loc.lng=p.coords.longitude;});
    
    function switchTab(t,e){
        document.getElementById('home-section').style.display=t==='home'?'block':'none';
        document.getElementById('history-section').style.display=t==='history'?'block':'none';
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); e.classList.add('active');
        if(t==='history') loadHistory();
    }
    document.querySelectorAll('.shift-btn').forEach(b=>{b.onclick=()=>{
        document.querySelectorAll('.shift-btn').forEach(x=>x.classList.remove('btn-wine','text-white'));
        b.classList.add('btn-wine','text-white'); currentShift=b.getAttribute('data-shift');
        document.getElementById('btn-in').disabled=false;
    }});
    async function send(type){
        const cvs=document.getElementById('canvas'); cvs.width=video.videoWidth; cvs.height=video.videoHeight;
        cvs.getContext('2d').drawImage(video,0,0);
        const res=await fetch('/api/'+type,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({shift:currentShift,photo:cvs.toDataURL('image/jpeg'),lat:loc.lat,lng:loc.lng})});
        const d=await res.json(); if(d.success){Swal.fire('Sukses','','success').then(()=>location.reload());}else{Swal.fire('Gagal',d.message,'error');}
    }
    document.getElementById('btn-in').onclick=()=>send('check_in'); document.getElementById('btn-out').onclick=()=>send('check_out');
    
    fetch('/api/status').then(r=>r.json()).then(d=>{
        const disp=document.getElementById('status-display');
        if(d.status==='CheckedIn'){disp.innerHTML=`<span class="text-success">Sudah Check-In (${d.shift})</span>`; document.getElementById('btn-in').style.display='none'; document.getElementById('btn-out').style.display='block'; document.getElementById('shift-buttons').style.display='none';}
        else if(d.status==='CheckedOut'){disp.innerHTML=`<span class="text-danger">Selesai</span>`; document.getElementById('btn-in').style.display='none'; document.getElementById('shift-buttons').style.display='none';}
        else{disp.innerText="Pilih Shift & Absen";}
    });
    function loadHistory(){
        fetch('/api/history').then(r=>r.json()).then(d=>{
            let h=''; d.forEach(i=>{h+=`<div class="list-group-item d-flex justify-content-between"><div><strong>${i.date}</strong><br>${i.shift}</div><span class="badge ${i.status==='Hadir'?'bg-success':'bg-danger'}">${i.status}</span></div>`});
            document.getElementById('history-list').innerHTML=h||'<div class="p-3 text-center">Kosong</div>';
        });
    }
</script>
{% endblock %}