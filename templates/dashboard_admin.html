{% extends "base.html" %}
{% block content %}
<div class="container-fluid pt-4">
    <div class="d-flex justify-content-between mb-4">
        <div><h5 class="fw-bold text-wine mb-0">{{ user_name }}</h5><span class="badge bg-wine">{{ role }}</span></div>
        <div><a href="/admin" class="btn btn-sm btn-outline-dark">Jadwal</a> <a href="/logout" class="btn btn-sm btn-outline-danger">Logout</a></div>
    </div>

    {% if pending_users %}
    <div class="card card-glass mb-4 border-warning"><div class="card-header fw-bold text-wine">Approval</div>
        <table class="table table-borderless small mb-0">{% for u in pending_users %}<tr><td>{{ u.full_name }} ({{ u.role }})</td><td class="text-end"><form action="/approve_user/{{ u.id }}" method="POST"><button class="btn btn-sm btn-success">ACC</button></form></td></tr>{% endfor %}</table>
    </div>
    {% endif %}

    <div class="card card-glass">
        <div class="card-header fw-bold text-wine d-flex justify-content-between"><span>Monitoring</span> <a href="/export" class="text-success small">Excel</a></div>
        <div class="table-responsive">
            <table class="table table-hover align-middle small mb-0"><thead class="table-light"><tr><th>Nama</th><th>Shift</th><th>Waktu</th><th>Bukti Foto</th><th>Act</th></tr></thead>
            <tbody>{% for row in monitoring_data %}<tr>
                <td><strong>{{ row.name }}</strong><br><span class="text-muted">{{ row.branch }}</span></td>
                <td>{{ row.shift }}</td>
                <td>{{ row.in }}<br>{{ row.out }}</td>
                <td>
                    {% if row.photo_in %}
                        <button class="btn btn-sm btn-outline-wine py-0" onclick="openLocalPhoto('{{ row.id }}', 'IN')">IN</button>
                    {% else %}
                        <button class="btn btn-sm btn-secondary py-0" disabled>No Foto</button>
                    {% endif %}

                    {% if row.photo_out %}
                        <button class="btn btn-sm btn-outline-danger py-0" onclick="openLocalPhoto('{{ row.id }}', 'OUT')">OUT</button>
                    {% else %}
                        <button class="btn btn-sm btn-secondary py-0" disabled>No Foto</button>
                    {% endif %}
                </td>
                <td>{% if row.potential_overtime and not row.is_overtime %}<form action="/approve_overtime/{{ row.id }}" method="POST"><button class="btn btn-sm btn-outline-primary py-0">ACC Lembur</button></form>{% endif %}</td>
            </tr>{% else %}<tr><td colspan="5" class="text-center p-3">Kosong</td></tr>{% endfor %}</tbody></table>
        </div>
    </div>
</div>

<script>
    const photoMap = {};
    {% for row in monitoring_data %}
        {% if row.photo_in %}photoMap['{{ row.id }}_IN'] = '{{ row.photo_in }}';{% endif %}
        {% if row.photo_out %}photoMap['{{ row.id }}_OUT'] = '{{ row.photo_out }}';{% endif %}
    {% endfor %}

    function openLocalPhoto(id, type) {
        const key = id + '_' + type;
        if (photoMap[key]) {
            showPhoto(photoMap[key], type);
        } else {
            console.error("Photo data missing for key:", key);
        }
    }
</script>
{% endblock %}